# Подключение MCP сервера Arryt к Claude Desktop

Мы разработали отдельный MCP сервер с поддержкой stdio протокола для интеграции с Claude Desktop.

## Что реализовано

- **Отдельное MCP приложение** в папке `/mcp_server/`
- **HTTP транспорт** - Streamable HTTP с поддержкой SSE
- **Прямое подключение к БД** - использует ту же базу данных что и основное API
- **TypeScript + Zod** для типобезопасности
- **Инструмент `arryt_terminal_operations`** для управления терминалами

## Архитектура

```
Claude Desktop → MCP Server (HTTP:3001) → PostgreSQL Database
```

MCP сервер работает как HTTP сервис на порту 3001 и подключается напрямую к базе данных PostgreSQL.

## Установка и настройка

### 1. Найдите конфигурационный файл Claude Desktop

**macOS:**
```bash
~/Library/Application Support/Claude/claude_desktop_config.json
```

**Windows:**
```bash
%APPDATA%/Claude/claude_desktop_config.json
```

### 2. Подготовьте MCP сервер

Перейдите в папку MCP сервера и установите зависимости:

```bash
cd mcp_server
bun install
bun run build
```

Создайте `.env` файл:
```bash
cp .env.example .env
```

Отредактируйте `.env` (используйте тот же DATABASE_URL что и в основном API):
```bash
# For local development
DATABASE_URL=postgresql://username:password@localhost:5432/arryt_db
PORT=3001

# For production
DATABASE_URL=postgresql://username:password@production-host:5432/arryt_db
PORT=3001
```

### 3. Запустите MCP сервер

```bash
cd mcp_server
bun run dev
# или для продакшена:
bun run build && bun run start
```

Сервер будет доступен на `http://localhost:3001/mcp`

### 4. Добавьте конфигурацию в Claude Desktop

**Для локальной разработки:**
```json
{
  "mcpServers": {
    "arryt": {
      "command": "npx",
      "args": [
        "-y",
        "mcp-remote",
        "http://localhost:3001/mcp"
      ]
    }
  }
}
```

### 5. Перезапустите Claude Desktop

После изменения конфигурации **полностью закройте и перезапустите** Claude Desktop.

## Проверка подключения

1. **Убедитесь что MCP сервер запущен:**
   ```bash
   cd mcp_server
   bun run dev
   ```

2. **Проверьте доступность эндпоинта:**
   ```bash
   curl -i http://localhost:3001/mcp
   ```

3. **Откройте новый чат в Claude Desktop**

4. **Проверьте доступность инструментов** - напишите: "Какие инструменты у тебя есть для работы с Arryt?"

5. **Если всё работает**, Claude ответит что у него есть доступ к `arryt_terminal_operations`

## Доступные инструменты

### arryt_terminal_operations

Управление терминалами (ресторанами) в системе Arryt.

**Поддерживаемые действия:**

**Получить список терминалов:**
- "Покажи все активные терминалы"
- "Сколько терминалов в организации XYZ?"

**Получить детали терминала:**
- "Покажи детали терминала с ID abc-123"
- "Какая информация о терминале на Чиланзаре?"

**Изменить статус терминала:**
- "Отключи терминал с ID xyz-789"
- "Активируй терминал abc-123"

**Получить статистику:**
- "Покажи статистику всех терминалов"
- "Какая статистика у терминала abc-123?"

## Отладка

### Если подключение не работает:

1. **Проверьте что API сервер запущен:**
   ```bash
   curl -i http://localhost:3000/check_service
   ```

2. **Проверьте сборку MCP сервера:**
   ```bash
   cd mcp_server
   bun run build
   node dist/index.js --help
   ```

3. **Проверьте конфигурацию Claude:**
   - Убедитесь что JSON файл валидный
   - Проверьте полный путь к `index.js`
   - Убедитесь что переменная `ARRYT_API_URL` правильная

4. **Проверьте логи** - MCP сервер пишет логи в stderr

5. **Перезапустите Claude Desktop** полностью

## Развертывание в продакшене

Для продакшена вы можете:

1. **Собрать MCP сервер:**
   ```bash
   cd mcp_server
   bun run build
   ```

2. **Развернуть на сервере** вместе с основным API

3. **Обновить конфигурацию Claude** с правильными путями и URL

## Примеры запросов через Claude Desktop

После успешного подключения вы сможете задавать Claude такие вопросы:

- "Покажи мне все активные терминалы"
- "Какая статистика по терминалу с ID abc-123?"
- "Сколько заказов сегодня было у всех терминалов?"
- "Отключи терминал с ID xyz-789"
- "Покажи детали терминала на Чиланзаре"

Claude будет использовать MCP сервер для получения актуальной информации из вашей системы Arryt.

---

**Готово!** Теперь у вас есть отдельный, стабильный MCP сервер, который Claude Desktop может использовать через stdio протокол для работы с данными терминалов Arryt.